{% extends "layout.html" %}

{% block title %}Add a track{% endblock %}

{% block content %}
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column">
                    <div class="file has-name is-boxed is-fullwidth">
                        <label class="file-label">
                            <input class="file-input" type="file" name="mp3file">
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span class="file-label">
                                    Drag and drop an MP3 file here, or click to browse
                                </span>
                            </span>
                            <span class="file-name">
                                No file selected
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <button class="lauchMusic" onclick="test()">Lauch</button>
        <button class="stopMusic" id="stopMusic">Lauch</button>

    </section>


    <script>
        const fileInput = document.querySelector('input[type="file"]');

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            const fileName = file.name;
            const fileLabel = document.querySelector('.file-name');
            fileLabel.textContent = fileName;
            console.log(file)
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/tracks', {
                method: 'POST',
                body: formData,
            });

            console.log(await response.json())
        });

        async function test() {
            await fetch('/tracks/64429343728d24d06ce01b75')
                .then(response => {
                    response.arrayBuffer().then(buffer => {
                        let context = new AudioContext();
                        context.decodeAudioData(buffer, decodedData => {
                            const sourceNode = context.createBufferSource();
                            sourceNode.buffer = decodedData;
                            sourceNode.connect(context.destination);
                            sourceNode.start();
                            document.getElementById('stopMusic').addEventListener('click', () => {
                                sourceNode.stop()
                            })
                        }, error => {
                            console.log('Une erreur est survenue lors du décodage des données audio', error);
                        });
                    });
                })

        }

    </script>
{% endblock %}